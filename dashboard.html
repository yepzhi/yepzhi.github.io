<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - hotFact</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        }

        .navbar-brand {
            color: white;
            font-size: 24px;
            font-weight: 700;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            text-align: right;
            color: white;
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
        }

        .user-rfc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .btn-logout {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-logout:hover {
            background: #c0392b;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.2);
            color: white;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        .card-icon {
            font-size: 30px;
            opacity: 0.6;
        }

        .stat-value {
            font-size: 40px;
            font-weight: 700;
            color: #48db97;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .info-box {
            background: rgba(255, 255, 255, 0.1);
            border-left: 5px solid #48db97;
            padding: 15px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
            font-weight: 600;
        }

        input[type="number"], 
        input[type="text"], 
        input[type="email"],
        input[type="file"],
        select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        input:focus, select:focus {
            border-color: #48db97;
            outline: none;
            box-shadow: 0 0 0 3px rgba(72, 219, 151, 0.5);
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 700;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-success {
            background: linear-gradient(135deg, #48db97 0%, #2ecc71 100%);
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            box-shadow: 0 4px 10px rgba(243, 156, 18, 0.4);
        }
        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
        }

        .btn-success:hover { background: #2ecc71; transform: translateY(-1px); }
        .btn-warning:hover { background: #e67e22; transform: translateY(-1px); }
        .btn-primary:hover { background: #2980b9; transform: translateY(-1px); }
        
        .btn:disabled {
            background: #aaa;
            cursor: not-allowed;
            box-shadow: none;
        }

        .help-text {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 5px;
        }
        
        .folio-box {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        
        .folio-code {
            font-size: 32px;
            font-weight: 700;
            color: #f39c12;
            letter-spacing: 5px;
            padding: 10px;
            border: 2px dashed #f39c12;
            display: inline-block;
            margin-bottom: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .folio-code:hover {
            background: rgba(243, 156, 18, 0.2);
        }
        
        .btn-copy {
            background: #34495e;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .error {
            color: #ff6b6b;
            font-weight: 600;
            margin-top: 10px;
        }

        .success {
            color: #48db97;
            font-weight: 600;
            margin-top: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        thead tr {
            background: rgba(255, 255, 255, 0.1);
            text-align: left;
        }

        th, td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .status-pendiente { color: #f39c12; font-weight: 600; }
        .status-facturado { color: #48db97; font-weight: 600; }
        .status-timbrado { color: #48db97; font-weight: 600; }
        .status-error { color: #e74c3c; font-weight: 600; }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            position: relative;
            color: white;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: white;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: white;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        
        .modal-close:hover {
            opacity: 1;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="navbar-brand">üî• hotFact</div>
        <div class="navbar-user">
            <div class="user-info">
                <div class="user-name" id="userName">Cargando...</div>
                <div class="user-rfc" id="userRFC">RFC: ---</div>
            </div>
            <button class="btn-logout" onclick="handleLogout()">Cerrar Sesi√≥n</button>
        </div>
    </div>
    
    <div class="container">
        <!-- Alerta de Perfil Incompleto -->
        <div id="profileAlert" class="card" style="margin-bottom: 20px; display: none; background: rgba(255, 193, 7, 0.1); border: 2px solid #ffc107;">
            <div class="card-header">
                <div class="card-title">‚ö†Ô∏è Perfil Fiscal Incompleto</div>
            </div>
            <div class="info-box" style="border-left-color: #ffc107;">
                <strong>Acci√≥n Requerida:</strong> Tu perfil fiscal est√° incompleto. Por favor completa los siguientes datos:
                <ul id="missingFields" style="margin-top: 10px; padding-left: 20px;"></ul>
            </div>
            <button class="btn btn-warning" onclick="openProfileModal()">‚úèÔ∏è Completar Perfil Ahora</button>
        </div>

        <!-- Configuraci√≥n de Empresa -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <div class="card-title">‚öôÔ∏è Configuraci√≥n de Empresa</div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label>P√°gina P√∫blica de Facturaci√≥n</label>
                    <div class="info-box" style="padding: 10px; border-left-color: #3498db;">
                        üîó <strong>URL:</strong> <a href="hotfact.html" target="_blank" style="color: #48db97;">hotfact.html</a>
                        <div class="help-text">Comparta esta URL con sus clientes.</div>
                    </div>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Subir Logo (.png o .jpg)</label>
                    <input type="file" id="logoFile" accept="image/png, image/jpeg">
                    <button class="btn btn-primary" onclick="uploadLogo()" id="uploadLogoBtn" style="width: 100%; margin-top: 10px;">üíæ Guardar Logo</button>
                    <div id="logoResult" style="margin-top: 5px;"></div>
                </div>
            </div>
        </div>

        <!-- Generar Folio -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <div class="card-title">üé´ Generar Folio de Facturaci√≥n</div>
            </div>
            <div class="info-box">
                üí° Genera un folio √∫nico. El cliente lo usar√° en la p√°gina p√∫blica para solicitar su factura.
            </div>
            <div class="form-group">
                <label>Monto Total de la Factura (MXN)</label>
                <input type="number" id="folioAmount" placeholder="0.00" step="0.01" min="0.01" style="font-size: 18px; font-weight: 600;">
                <div class="help-text">IVA 16% incluido autom√°ticamente</div>
            </div>
            <div class="form-group">
                <label>Descripci√≥n (Opcional)</label>
                <input type="text" id="folioDescription" placeholder="Ej: Mesa 5, Pedido #123">
            </div>
            <button class="btn btn-success" onclick="generateFolio()">üî• Generar Folio</button>
            <div id="folioResult"></div>
        </div>

        <!-- Facturaci√≥n Inmediata -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <div class="card-title">‚ö° Facturaci√≥n Inmediata</div>
            </div>
            <div class="info-box" style="border-left-color: #48db97;">
                ‚ö° <strong>Timbrado Instant√°neo:</strong> La factura se timbra inmediatamente con Finkok y se generan archivos PDF y XML reales.
            </div>
            <button class="btn btn-warning" onclick="openDirectInvoiceModal()">‚ö° Facturar Ahora</button>
        </div>

        <!-- Dashboard Stats -->
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Folios Generados</div>
                    <div class="card-icon">üìÑ</div>
                </div>
                <div class="stat-value" id="totalFolios">0</div>
                <div class="stat-label">Total en sistema</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Monto Total Pendiente</div>
                    <div class="card-icon">üí∞</div>
                </div>
                <div class="stat-value" id="totalAmount">$0.00</div>
                <div class="stat-label">Monto acumulado a facturar</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Folios Facturados</div>
                    <div class="card-icon">‚úÖ</div>
                </div>
                <div class="stat-value" id="invoicedFolios">0</div>
                <div class="stat-label">Total timbrado</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Folios Pendientes</div>
                    <div class="card-icon">‚ö†Ô∏è</div>
                </div>
                <div class="stat-value" id="pendingFolios">0</div>
                <div class="stat-label">Esperando solicitud</div>
            </div>
        </div>

        <!-- Tabla de Folios -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Lista de Folios y Solicitudes</div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Folio / ID</th>
                            <th>Monto</th>
                            <th>Descripci√≥n</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="foliosTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center;">Cargando datos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Facturaci√≥n Inmediata -->
    <div id="directInvoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚ö° Facturaci√≥n Inmediata</div>
                <button class="modal-close" onclick="closeDirectInvoiceModal()">√ó</button>
            </div>
            
            <form id="directInvoiceForm">
                <div class="info-box" style="border-left-color: #48db97;">
                    <strong>Timbrado Instant√°neo:</strong> El CFDI se procesar√° inmediatamente con Finkok y recibir√°s archivos PDF y XML reales.
                </div>

                <div class="card-title" style="margin-top: 10px; margin-bottom: 10px;">Datos del Receptor</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>RFC</label>
                        <input type="text" id="directReceptorRFC" placeholder="XAXX010101000" maxlength="13" required>
                    </div>
                    <div class="form-group">
                        <label>Raz√≥n Social / Nombre</label>
                        <input type="text" id="directReceptorNombre" placeholder="Raz√≥n Social" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>R√©gimen Fiscal</label>
                        <select id="directRegimenFiscal" required>
                            <option value="">Selecciona...</option>
                            <option value="601">601 - General de Ley PM</option>
                            <option value="605">605 - Sueldos y Salarios</option>
                            <option value="606">606 - Arrendamiento</option>
                            <option value="612">612 - PF con Act. Empresariales</option>
                            <option value="616" selected>616 - Sin obligaciones fiscales</option>
                            <option value="626">626 - R√©gimen Simplificado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Uso de CFDI</label>
                        <select id="directUsoCFDI" required>
                            <option value="G03">G03 - Gastos en general</option>
                            <option value="S01" selected>S01 - Sin efectos fiscales</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="directReceptorEmail" placeholder="cliente@correo.com" required>
                </div>

                <div class="card-title" style="margin-top: 20px; margin-bottom: 10px;">Detalle de Factura</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Monto Total (MXN)</label>
                        <input type="number" id="directAmount" placeholder="116.00" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n del Concepto</label>
                        <input type="text" id="directConcepto" placeholder="Servicio de Consultor√≠a" required>
                    </div>
                </div>
                
                <div id="directInvoiceMessage"></div>

                <button type="button" class="btn btn-warning" id="saveDirectInvoiceBtn" onclick="timbrarFacturaInmediata()" style="width: 100%;">‚ö° Timbrar Factura Ahora</button>
            </form>
        </div>
    </div>

    <!-- Modal de Perfil Fiscal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚úèÔ∏è Completar Perfil Fiscal</div>
                <button class="modal-close" onclick="closeProfileModal()">√ó</button>
            </div>
            
            <form id="profileForm" onsubmit="event.preventDefault(); saveProfile();">
                <div class="info-box">
                    üí° <strong>Importante:</strong> Estos datos se usar√°n como emisor en todas tus facturas.
                </div>

                <div class="form-group">
                    <label>Nombre / Raz√≥n Social *</label>
                    <input type="text" id="profileNombre" placeholder="Mi Negocio SA de CV" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>RFC *</label>
                        <input type="text" id="profileRFC" placeholder="XAXX010101000" maxlength="13" required>
                    </div>
                    <div class="form-group">
                        <label>C√≥digo Postal *</label>
                        <input type="text" id="profileCP" placeholder="83000" maxlength="5" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>R√©gimen Fiscal *</label>
                    <select id="profileRegimenFiscal" required>
                        <option value="">Selecciona...</option>
                        <option value="601">601 - General de Ley PM</option>
                        <option value="603">603 - Personas Morales sin Fines de Lucro</option>
                        <option value="605">605 - Sueldos y Salarios</option>
                        <option value="606">606 - Arrendamiento</option>
                        <option value="607">607 - R√©gimen de Enajenaci√≥n</option>
                        <option value="608">608 - Dem√°s Ingresos</option>
                        <option value="610">610 - Residentes en el Extranjero</option>
                        <option value="611">611 - Ingresos por Dividendos</option>
                        <option value="612">612 - PF con Act. Empresariales</option>
                        <option value="614">614 - Ingresos por Intereses</option>
                        <option value="615">615 - R√©gimen de Actividades Agr√≠colas</option>
                        <option value="616">616 - Sin Obligaciones Fiscales</option>
                        <option value="620">620 - Sociedades Cooperativas de Producci√≥n</option>
                        <option value="621">621 - Incorporaci√≥n Fiscal</option>
                        <option value="622">622 - Act. Agr√≠colas, Ganaderas, Silv√≠colas</option>
                        <option value="623">623 - Opcional para Grupos de Sociedades</option>
                        <option value="624">624 - Coordinados</option>
                        <option value="625">625 - R√©gimen de las Actividades Empresariales con Ingresos a Trav√©s de Plataformas Tecnol√≥gicas</option>
                        <option value="626" selected>626 - R√©gimen Simplificado de Confianza</option>
                    </select>
                </div>
                
                <div id="profileMessage"></div>

                <button type="submit" class="btn btn-success" id="saveProfileBtn" style="width: 100%;">üíæ Guardar Perfil</button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>
    <script>
        // CONFIGURACI√ìN DE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyB_H-Eu5PVkaWKanA0q7_Fo5LSPgBYhbhQ", 
            authDomain: "hotfact-9902f.firebaseapp.com",
            projectId: "hotfact-9902f",
            storageBucket: "hotfact-9902f.firebasestorage.app",
            messagingSenderId: "33455575295",
            appId: "1:33455575295:web:77d406be9d4f6a6ec5fcca"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const functions = firebase.functions();

        let userData = {}; 

        // FUNCIONES DE UTILIDAD
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(amount);
        }

        function copyToClipboard(text, elementId) {
            navigator.clipboard.writeText(text).then(() => {
                const element = document.getElementById(elementId);
                const originalText = element.textContent;
                element.textContent = '‚úÖ ¬°Copiado!';
                setTimeout(() => {
                    element.textContent = originalText;
                }, 1500);
            }).catch(err => {
                console.error('Error al copiar:', err);
            });
        }
        
        async function handleLogout() {
            console.log('Cerrando sesi√≥n...');
            try {
                await auth.signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error("Error al cerrar sesi√≥n:", error);
            }
        }
        
        function generateSimpleFolio() {
            return Math.floor(10000000 + Math.random() * 90000000).toString();
        }

        function getStatusClass(status) {
            switch(status) {
                case 'pendiente': return 'status-pendiente';
                case 'facturado': return 'status-facturado';
                case 'timbrado': return 'status-timbrado';
                case 'error': return 'status-error';
                default: return '';
            }
        }

        // SUBIR LOGO
        async function uploadLogo() {
            const logoInput = document.getElementById('logoFile');
            const resultDiv = document.getElementById('logoResult');
            const btn = document.getElementById('uploadLogoBtn');
            const file = logoInput.files[0];

            if (!file) {
                resultDiv.innerHTML = '<div class="error">Selecciona un archivo de imagen.</div>';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Subiendo...';
            resultDiv.innerHTML = '';
            
            try {
                const logoRef = storage.ref(`logos/${userData.uid}/logo.png`);
                const snapshot = await logoRef.put(file);
                const logoUrl = await snapshot.ref.getDownloadURL();

                await db.collection('users').doc(userData.uid).update({
                    logoUrl: logoUrl,
                    logoUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                resultDiv.innerHTML = '<div class="success">‚úÖ Logo subido exitosamente</div>';
                userData.logoUrl = logoUrl;

            } catch (error) {
                console.error("Error:", error);
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üíæ Guardar Logo';
            }
        }
        
        // GENERAR FOLIO
        async function generateFolio() {
            const amountInput = document.getElementById('folioAmount');
            const descriptionInput = document.getElementById('folioDescription');
            const resultDiv = document.getElementById('folioResult');
            
            const monto = parseFloat(amountInput.value);
            const description = descriptionInput.value.trim() || 'Venta de Productos/Servicios';

            if (isNaN(monto) || monto <= 0) {
                resultDiv.innerHTML = '<div class="error">Ingresa un monto v√°lido.</div>';
                return;
            }

            // Validar datos fiscales cr√≠ticos
            if (!userData.rfc || !userData.nombre) {
                resultDiv.innerHTML = '<div class="error">‚ö†Ô∏è Faltan RFC y Nombre de la empresa. Completa tu perfil.</div>';
                return;
            }

            // Si falta CP, usar uno por defecto con advertencia
            if (!userData.cp || userData.cp.trim() === '') {
                console.warn('‚ö†Ô∏è CP no configurado, usando CP por defecto: 83000');
                userData.cp = '83000'; // CP gen√©rico de Hermosillo, Sonora
                
                // Mostrar advertencia
                resultDiv.innerHTML = '<div class="error">‚ö†Ô∏è C√≥digo Postal no configurado. Se usar√° CP gen√©rico (83000). Por favor actualiza tu perfil.</div>';
                
                // Actualizar en Firestore para la pr√≥xima vez
                try {
                    await db.collection('users').doc(userData.uid).update({
                        cp: '83000'
                    });
                } catch (error) {
                    console.error('Error actualizando CP:', error);
                }
            }

            if (!userData.regimenFiscal) {
                userData.regimenFiscal = '601'; // R√©gimen por defecto
            }

            const subtotal = monto / 1.16;
            const iva = monto - subtotal;
            const folioCode = generateSimpleFolio();

            const folioData = {
                businessId: userData.uid,
                emisor: {
                    rfc: userData.rfc,
                    nombre: userData.nombre,
                    cp: userData.cp,
                    regimenFiscal: userData.regimenFiscal
                },
                description: description,
                conceptos: [
                    {
                        cantidad: 1,
                        descripcion: description,
                        claveProdServ: '84111506',
                        claveUnidad: 'ACT',
                        precioUnitario: parseFloat(subtotal.toFixed(2)),
                        subtotal: parseFloat(subtotal.toFixed(2))
                    }
                ],
                totales: {
                    subtotal: parseFloat(subtotal.toFixed(2)),
                    iva: parseFloat(iva.toFixed(2)),
                    total: parseFloat(monto.toFixed(2))
                },
                status: 'pendiente', 
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('folios').doc(folioCode).set(folioData);
                
                const genericLink = "hotfact.html"; 
                
                resultDiv.innerHTML = `
                    <div class="folio-box">
                        <p style="color: white;">Folio generado. El cliente debe ingresar a <strong>${genericLink}</strong> y usar:</p>
                        <div class="folio-code" id="folioCodeDisplay" onclick="copyToClipboard('${folioCode}', 'folioCodeDisplay')">${folioCode}</div>
                        <button class="btn-copy" onclick="copyToClipboard('${folioCode}', 'folioCodeDisplay')">üìã Copiar C√≥digo</button>
                    </div>
                `;

                amountInput.value = '';
                descriptionInput.value = '';
                
            } catch (error) {
                console.error("Error:", error);
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        // MODAL FACTURACI√ìN INMEDIATA
        function openDirectInvoiceModal() {
            document.getElementById('directInvoiceModal').classList.add('active');
            document.getElementById('directInvoiceMessage').innerHTML = '';
        }

        function closeDirectInvoiceModal() {
            document.getElementById('directInvoiceModal').classList.remove('active');
        }

        // MODAL DE PERFIL
        function openProfileModal() {
            document.getElementById('profileModal').classList.add('active');
            
            // Pre-llenar con datos actuales
            document.getElementById('profileNombre').value = userData.nombre || '';
            document.getElementById('profileRFC').value = userData.rfc || '';
            document.getElementById('profileCP').value = userData.cp || '';
            document.getElementById('profileRegimenFiscal').value = userData.regimenFiscal || '626';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
        }

        async function saveProfile() {
            const messageDiv = document.getElementById('profileMessage');
            const btn = document.getElementById('saveProfileBtn');
            
            const nombre = document.getElementById('profileNombre').value.trim();
            const rfc = document.getElementById('profileRFC').value.trim().toUpperCase();
            const cp = document.getElementById('profileCP').value.trim();
            const regimenFiscal = document.getElementById('profileRegimenFiscal').value;
            
            if (!nombre || !rfc || !cp || !regimenFiscal) {
                messageDiv.innerHTML = '<div class="error">‚ö†Ô∏è Todos los campos son obligatorios</div>';
                return;
            }

            // Validar RFC
            const rfcPattern = /^[A-Z√ë&]{3,4}\d{6}[A-Z0-9]{3}$/;
            if (!rfcPattern.test(rfc)) {
                messageDiv.innerHTML = '<div class="error">‚ö†Ô∏è RFC inv√°lido</div>';
                return;
            }

            // Validar CP
            if (!/^\d{5}$/.test(cp)) {
                messageDiv.innerHTML = '<div class="error">‚ö†Ô∏è C√≥digo Postal debe tener 5 d√≠gitos</div>';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Guardando...';
            messageDiv.innerHTML = '';

            try {
                await db.collection('users').doc(userData.uid).update({
                    nombre: nombre,
                    businessName: nombre,
                    rfc: rfc,
                    cp: cp,
                    codigoPostal: cp,
                    regimenFiscal: regimenFiscal,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Actualizar userData local
                userData.nombre = nombre;
                userData.rfc = rfc;
                userData.cp = cp;
                userData.regimenFiscal = regimenFiscal;

                // Actualizar UI
                document.getElementById('userName').textContent = nombre;
                document.getElementById('userRFC').textContent = `RFC: ${rfc}`;

                messageDiv.innerHTML = '<div class="success">‚úÖ Perfil actualizado exitosamente</div>';

                setTimeout(() => {
                    closeProfileModal();
                    checkProfileComplete(); // Verificar si ahora est√° completo
                }, 2000);

            } catch (error) {
                console.error('Error:', error);
                messageDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üíæ Guardar Perfil';
            }
        }

        // Verificar si el perfil est√° completo
        function checkProfileComplete() {
            const missingFields = [];
            
            if (!userData.nombre || userData.nombre.trim() === '') missingFields.push('Nombre / Raz√≥n Social');
            if (!userData.rfc || userData.rfc.trim() === '') missingFields.push('RFC');
            if (!userData.cp || userData.cp.trim() === '') missingFields.push('C√≥digo Postal');
            if (!userData.regimenFiscal || userData.regimenFiscal.trim() === '') missingFields.push('R√©gimen Fiscal');

            const alertDiv = document.getElementById('profileAlert');
            const missingFieldsList = document.getElementById('missingFields');

            if (missingFields.length > 0) {
                missingFieldsList.innerHTML = missingFields.map(field => `<li>${field}</li>`).join('');
                alertDiv.style.display = 'block';
            } else {
                alertDiv.style.display = 'none';
            }
        }

        // TIMBRAR FACTURA INMEDIATA
        async function timbrarFacturaInmediata() {
            const messageDiv = document.getElementById('directInvoiceMessage');
            const btn = document.getElementById('saveDirectInvoiceBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Timbrando con Finkok...';
            messageDiv.innerHTML = '';
            
            const rfc = document.getElementById('directReceptorRFC').value.toUpperCase();
            const nombre = document.getElementById('directReceptorNombre').value.trim();
            const email = document.getElementById('directReceptorEmail').value.trim();
            const usoCFDI = document.getElementById('directUsoCFDI').value;
            const regimenFiscal = document.getElementById('directRegimenFiscal').value;
            const monto = parseFloat(document.getElementById('directAmount').value);
            const description = document.getElementById('directConcepto').value.trim();

            if (!rfc || !nombre || !email || !usoCFDI || !regimenFiscal || isNaN(monto) || monto <= 0 || !description) {
                messageDiv.innerHTML = '<div class="error">‚ö†Ô∏è Por favor, completa todos los campos.</div>';
                btn.disabled = false;
                btn.textContent = '‚ö° Timbrar Factura Ahora';
                return;
            }
            
            // Verificar datos del emisor
            if (!userData.rfc || !userData.nombre) {
                messageDiv.innerHTML = '<div class="error">‚ö†Ô∏è Faltan RFC y Nombre del emisor. Completa tu perfil.</div>';
                btn.disabled = false;
                btn.textContent = '‚ö° Timbrar Factura Ahora';
                return;
            }

            // Si falta CP, usar uno por defecto
            if (!userData.cp || userData.cp.trim() === '') {
                console.warn('‚ö†Ô∏è CP no configurado, usando CP por defecto: 83000');
                userData.cp = '83000';
                
                // Actualizar en Firestore
                try {
                    await db.collection('users').doc(userData.uid).update({
                        cp: '83000'
                    });
                } catch (error) {
                    console.error('Error actualizando CP:', error);
                }
            }

            if (!userData.regimenFiscal) {
                userData.regimenFiscal = '601';
            }

            // Verificar que tenga certificados
            try {
                const certDoc = await db.collection('certificates').doc(userData.uid).get();
                if (!certDoc.exists) {
                    messageDiv.innerHTML = '<div class="error">‚ö†Ô∏è No tienes certificados .CER y .KEY cargados. Config√∫ralos primero.</div>';
                    btn.disabled = false;
                    btn.textContent = '‚ö° Timbrar Factura Ahora';
                    return;
                }
            } catch (error) {
                console.error('Error verificando certificados:', error);
                messageDiv.innerHTML = '<div class="error">‚ùå Error al verificar certificados.</div>';
                btn.disabled = false;
                btn.textContent = '‚ö° Timbrar Factura Ahora';
                return;
            }
            
            const subtotal = monto / 1.16;
            const iva = monto - subtotal;

            // Preparar datos completos para el timbrado
            const cfdiData = {
                businessId: userData.uid,
                emisor: {
                    rfc: userData.rfc,
                    nombre: userData.nombre,
                    regimenFiscal: userData.regimenFiscal
                },
                receptor: {
                    rfc: rfc,
                    nombre: nombre,
                    email: email,
                    usoCFDI: usoCFDI,
                    regimenFiscal: regimenFiscal,
                    domicilioFiscalReceptor: "00000"
                },
                conceptos: [
                    {
                        claveProdServ: '84111506',
                        claveUnidad: 'ACT',
                        cantidad: 1,
                        descripcion: description,
                        valorUnitario: parseFloat(subtotal.toFixed(2)),
                        importe: parseFloat(subtotal.toFixed(2)),
                        objetoImp: '02'
                    }
                ],
                impuestos: {
                    totalImpuestosTrasladados: parseFloat(iva.toFixed(2)),
                    traslados: [
                        {
                            base: parseFloat(subtotal.toFixed(2)),
                            impuesto: '002',
                            tipoFactor: 'Tasa',
                            tasaOCuota: '0.160000',
                            importe: parseFloat(iva.toFixed(2))
                        }
                    ]
                },
                totales: {
                    subTotal: parseFloat(subtotal.toFixed(2)),
                    total: parseFloat(monto.toFixed(2))
                },
                formaPago: '03',
                metodoPago: 'PUE',
                tipoDeComprobante: 'I',
                exportacion: '01',
                lugarExpedicion: userData.cp,
                moneda: 'MXN'
            };

            try {
                messageDiv.innerHTML = '<div class="info-box">üì° Conectando con Finkok para timbrar...</div>';
                
                // Llamar a Cloud Function para timbrar
                const timbrarFunction = functions.httpsCallable('timbrarFacturaInmediata');
                const result = await timbrarFunction({
                    cfdiData: cfdiData
                });

                if (result.data.success) {
                    const { uuid, xmlUrl, pdfUrl } = result.data;
                    
                    messageDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ <strong>¬°Factura timbrada exitosamente!</strong><br><br>
                            <strong>UUID:</strong> ${uuid}<br><br>
                            <a href="${xmlUrl}" target="_blank" style="color: #48db97; text-decoration: underline;">üìÑ Descargar XML</a> | 
                            <a href="${pdfUrl}" target="_blank" style="color: #48db97; text-decoration: underline;">üìÑ Descargar PDF</a>
                        </div>
                    `;
                    
                    // Guardar en Firestore para referencia
                    await db.collection('invoices').add({
                        businessId: userData.uid,
                        uuid: uuid,
                        xmlUrl: xmlUrl,
                        pdfUrl: pdfUrl,
                        receptor: {
                            rfc: rfc,
                            nombre: nombre,
                            email: email
                        },
                        total: monto,
                        status: 'timbrado',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Enviar email
                    console.log('Enviando email a:', email);
                    
                    setTimeout(() => {
                        closeDirectInvoiceModal();
                        document.getElementById('directInvoiceForm').reset();
                    }, 5000);
                    
                } else {
                    throw new Error(result.data.error || 'Error desconocido en el timbrado');
                }

            } catch (error) {
                console.error('Error al timbrar:', error);
                messageDiv.innerHTML = `<div class="error">‚ùå Error al timbrar: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ö° Timbrar Factura Ahora';
            }
        }

        // DASHBOARD EN TIEMPO REAL
        function setupRealtimeDashboard() {
            const foliosRef = db.collection('folios').where('businessId', '==', userData.uid);
            const invoicesRef = db.collection('invoices').where('businessId', '==', userData.uid);

            foliosRef.onSnapshot(snapshot => updateDashboard(snapshot, 'folio'));
            invoicesRef.onSnapshot(snapshot => updateDashboard(snapshot, 'invoice'));
        }

        let allInvoices = {};
        
        function updateDashboard(snapshot, type) {
            let totalFolios = 0;
            let totalAmount = 0;
            let invoicedFolios = 0;
            let pendingFolios = 0;
            
            snapshot.docChanges().forEach(change => {
                const docData = change.doc.data();
                const docId = `${type}_${change.doc.id}`;
                
                if (change.type === "added" || change.type === "modified") {
                    allInvoices[docId] = { id: change.doc.id, type: type, ...docData };
                } else if (change.type === "removed") {
                    delete allInvoices[docId];
                }
            });
            
            const foliosTableBody = document.getElementById('foliosTableBody');
            foliosTableBody.innerHTML = '';
            
            const sortedInvoices = Object.values(allInvoices).sort((a, b) => {
                const aTime = a.createdAt && a.createdAt.seconds ? a.createdAt.seconds : 0;
                const bTime = b.createdAt && b.createdAt.seconds ? b.createdAt.seconds : 0;
                return bTime - aTime;
            });

            sortedInvoices.forEach(docData => {
                totalFolios++;
                const montoTotal = docData.totales ? docData.totales.total : (docData.total || 0);
                
                if (docData.status === 'pendiente') {
                    pendingFolios++;
                    totalAmount += montoTotal;
                } else if (docData.status === 'facturado' || docData.status === 'timbrado') {
                    invoicedFolios++;
                }

                const row = foliosTableBody.insertRow();
                const folioId = docData.type === 'folio' ? docData.id : `INV-${docData.id.substring(0, 6)}`;
                const description = docData.description || (docData.conceptos && docData.conceptos.length > 0 ? docData.conceptos[0].descripcion : 'Sin descripci√≥n');
                
                const downloadBtn = docData.uuid ? 
                    `<a href="${docData.xmlUrl}" target="_blank" class="btn" style="background-color: #34495e; padding: 5px 10px; font-size: 12px; text-decoration: none;">üì• Descargar</a>` :
                    '<span style="color: rgba(255,255,255,0.5); font-size: 12px;">N/A</span>';
                
                row.innerHTML = `
                    <td>${folioId}</td>
                    <td>${formatCurrency(montoTotal)}</td>
                    <td>${description}</td>
                    <td class="${getStatusClass(docData.status)}">${docData.status.toUpperCase()}</td>
                    <td>${downloadBtn}</td>
                `;
            });

            document.getElementById('totalFolios').textContent = totalFolios;
            document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
            document.getElementById('invoicedFolios').textContent = invoicedFolios;
            document.getElementById('pendingFolios').textContent = pendingFolios;

            if (totalFolios === 0) {
                foliosTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay folios o solicitudes registrados.</td></tr>';
            }
        }

        // AUTENTICACI√ìN Y CARGA INICIAL
        auth.onAuthStateChanged(user => {
            if (user) {
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        userData = { 
                            uid: user.uid,
                            email: data.email || '',
                            nombre: data.businessName || data.nombre || data.razonSocial || '',
                            rfc: data.rfc || '',
                            cp: data.codigoPostal || data.cp || '',
                            regimenFiscal: data.regimenFiscal || '601',
                            logoUrl: data.logoUrl || null
                        };
                        
                        console.log('Usuario cargado:', userData);
                        
                        document.getElementById('userName').textContent = userData.nombre || 'Administrador';
                        document.getElementById('userRFC').textContent = `RFC: ${userData.rfc || 'N/A'}`;
                        
                        // Verificar si el perfil est√° completo
                        checkProfileComplete();
                        
                        setupRealtimeDashboard(); 
                    } else {
                        console.error("No se encontraron datos de la empresa.");
                        handleLogout(); 
                    }
                }).catch(err => {
                    console.error("Error:", err);
                    handleLogout(); 
                });
            } else {
                window.location.href = 'login.html'; 
            }
        });

        window.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('directInvoiceForm');
            if (form) {
                form.addEventListener('submit', (e) => e.preventDefault());
            }
        });
    </script>
</body>
</html>