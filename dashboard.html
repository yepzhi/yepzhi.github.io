<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - hotFact</title>
    <style>
        /* ==================================== */
        /* CSS COMPLETO INTEGRADO (DISE√ëO DASHBOARD) */
        /* ==================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        }

        .navbar-brand {
            color: white;
            font-size: 24px;
            font-weight: 700;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            text-align: right;
            color: white;
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
        }

        .user-rfc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .btn-logout {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-logout:hover {
            background: #c0392b;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.2);
            color: white;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        .card-icon {
            font-size: 30px;
            opacity: 0.6;
        }

        .stat-value {
            font-size: 40px;
            font-weight: 700;
            color: #48db97;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .info-box {
            background: rgba(255, 255, 255, 0.1);
            border-left: 5px solid #48db97;
            padding: 15px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
            font-weight: 600;
        }

        input[type="number"], 
        input[type="text"], 
        input[type="email"],
        input[type="file"],
        select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus, 
        input[type="text"]:focus, 
        input[type="email"]:focus, 
        input[type="file"]:focus,
        select:focus {
            border-color: #48db97;
            outline: none;
            box-shadow: 0 0 0 3px rgba(72, 219, 151, 0.5);
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 700;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-success {
            background: linear-gradient(135deg, #48db97 0%, #2ecc71 100%);
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            box-shadow: 0 4px 10px rgba(243, 156, 18, 0.4);
        }
        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
        }

        .btn-success:hover { background: #2ecc71; transform: translateY(-1px); }
        .btn-warning:hover { background: #e67e22; transform: translateY(-1px); }
        .btn-primary:hover { background: #2980b9; transform: translateY(-1px); }
        
        .btn:disabled {
            background: #aaa;
            cursor: not-allowed;
            box-shadow: none;
        }

        .help-text {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 5px;
        }
        
        .folio-box {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        
        .folio-code {
            font-size: 32px;
            font-weight: 700;
            color: #f39c12;
            letter-spacing: 5px;
            padding: 10px;
            border: 2px dashed #f39c12;
            display: inline-block;
            margin-bottom: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .folio-code:hover {
            background: rgba(243, 156, 18, 0.2);
        }
        
        .btn-copy {
            background: #34495e;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .error {
            color: #ff6b6b;
            font-weight: 600;
            margin-top: 10px;
        }

        .success {
            color: #48db97;
            font-weight: 600;
            margin-top: 10px;
        }

        /* Tabla */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        thead tr {
            background: rgba(255, 255, 255, 0.1);
            text-align: left;
        }

        th, td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .status-pendiente { color: #f39c12; font-weight: 600; }
        .status-facturado { color: #48db97; font-weight: 600; }
        .status-error { color: #e74c3c; font-weight: 600; }
        .status-pendiente_timbrado { color: #3498db; font-weight: 600; }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: white;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: white;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        
        .modal-close:hover {
            opacity: 1;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
        }
        
        /* Ocultar temporalmente al inicio */
        .hidden {
            display: none;
        }

    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="navbar-brand">üî• hotFact</div>
        <div class="navbar-user">
            <div class="user-info">
                <div class="user-name" id="userName">Cargando...</div>
                <div class="user-rfc" id="userRFC">RFC: ---</div>
            </div>
            <button class="btn-logout" onclick="handleLogout()">Cerrar Sesi√≥n</button>
        </div>
    </div>
    
    <div class="container">
        <!-- Secci√≥n: Configuraci√≥n de Empresa (Logo) -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <div class="card-title">‚öôÔ∏è Configuraci√≥n de Empresa</div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label>P√°gina P√∫blica de Facturaci√≥n</label>
                    <div class="info-box" style="padding: 10px; border-left-color: #3498db;">
                        üîó **URL:** <a href="hotfact.html" target="_blank" style="color: #48db97; word-break: break-all;">hotfact.html</a>
                        <div class="help-text">Comparta esta URL con sus clientes.</div>
                    </div>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Subir Logo (.png o .jpg)</label>
                    <input type="file" id="logoFile" accept="image/png, image/jpeg">
                    <button class="btn btn-primary" onclick="uploadLogo()" id="uploadLogoBtn" style="width: 100%; margin-top: 10px;">üíæ Guardar y Subir Logo</button>
                    <div id="logoResult" style="margin-top: 5px;"></div>
                </div>
            </div>
        </div>


        <!-- Generar Folio -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <div class="card-title">üé´ Generar Folio de Facturaci√≥n</div>
            </div>
            <div class="info-box">
                üí° Genera un folio √∫nico. El cliente lo usar√° en la p√°gina p√∫blica para solicitar su factura.
            </div>
            <div class="form-group">
                <label>Monto Total de la Factura (MXN)</label>
                <input type="number" id="folioAmount" placeholder="0.00" step="0.01" min="0.01" style="font-size: 18px; font-weight: 600;">
                <div class="help-text">IVA 16% incluido autom√°ticamente</div>
            </div>
            <div class="form-group">
                <label>Descripci√≥n (Opcional)</label>
                <input type="text" id="folioDescription" placeholder="Ej: Mesa 5, Pedido #123">
            </div>
            <button class="btn btn-success" onclick="generateFolio()">üî• Generar Folio</button>
            <div id="folioResult"></div>
        </div>

        <!-- Facturaci√≥n Directa -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <div class="card-title">‚ö° Facturaci√≥n Directa (Sin Folio)</div>
            </div>
            <div class="info-box" style="border-left-color: #f39c12;">
                ‚ö° Para facturas inmediatas. Se crea una solicitud de timbrado directo.
            </div>
            <button class="btn btn-warning" onclick="openDirectInvoiceModal()">‚ö° Facturar Ahora</button>
        </div>

        <!-- Dashboard Stats (DIN√ÅMICOS) -->
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Folios Generados</div>
                    <div class="card-icon">üìÑ</div>
                </div>
                <div class="stat-value" id="totalFolios">0</div>
                <div class="stat-label">Total en sistema</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Monto Total Pendiente</div>
                    <div class="card-icon">üí∞</div>
                </div>
                <div class="stat-value" id="totalAmount">$0.00</div>
                <div class="stat-label">Monto acumulado a facturar</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Folios Facturados</div>
                    <div class="card-icon">‚úÖ</div>
                </div>
                <div class="stat-value" id="invoicedFolios">0</div>
                <div class="stat-label">Total timbrado</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Folios Pendientes</div>
                    <div class="card-icon">‚ö†Ô∏è</div>
                </div>
                <div class="stat-value" id="pendingFolios">0</div>
                <div class="stat-label">Esperando solicitud del cliente</div>
            </div>
        </div>

        <!-- Tabla de Folios (DIN√ÅMICA) -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Lista de Folios y Solicitudes</div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Folio / ID</th>
                            <th>Monto</th>
                            <th>Descripci√≥n</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="foliosTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center;">Cargando datos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Facturaci√≥n Directa -->
    <div id="directInvoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Facturaci√≥n Inmediata</div>
                <button class="modal-close" onclick="closeDirectInvoiceModal()">√ó</button>
            </div>
            
            <form id="directInvoiceForm">
                <div class="info-box" style="border-left-color: #f39c12;">
                    <strong>Importante:</strong> Esto crear√° un documento en Firestore con estado **pendiente\_timbrado** que debe ser procesado por tu Cloud Function.
                </div>

                <!-- Receptor -->
                <div class="card-title" style="margin-top: 10px; margin-bottom: 10px; color: white;">Datos del Receptor</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>RFC</label>
                        <input type="text" id="directReceptorRFC" placeholder="XAXX010101000" maxlength="13" required>
                    </div>
                    <div class="form-group">
                        <label>Raz√≥n Social / Nombre</label>
                        <input type="text" id="directReceptorNombre" placeholder="Raz√≥n Social" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>R√©gimen Fiscal</label>
                        <select id="directRegimenFiscal" required>
                            <option value="">Selecciona...</option>
                            <option value="601">601 - General de Ley Personas Morales</option>
                            <option value="605">605 - Sueldos y Salarios</option>
                            <option value="606">606 - Arrendamiento</option>
                            <option value="612">612 - P.F. con Act. Empresariales</option>
                            <option value="616" selected>616 - Sin obligaciones fiscales (P√∫blico General)</option>
                            <option value="626">626 - R√©gimen Simplificado de Confianza</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Uso de CFDI</label>
                        <select id="directUsoCFDI" required>
                            <option value="G03">G03 - Gastos en general</option>
                            <option value="S01" selected>S01 - Sin efectos fiscales</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="directReceptorEmail" placeholder="cliente@correo.com" required>
                </div>

                <!-- Monto y Concepto -->
                <div class="card-title" style="margin-top: 20px; margin-bottom: 10px; color: white;">Detalle de Factura</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Monto Total (MXN)</label>
                        <input type="number" id="directAmount" placeholder="116.00" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n del Concepto</label>
                        <input type="text" id="directConcepto" placeholder="Servicio de Consultor√≠a" required>
                    </div>
                </div>
                
                <div id="directInvoiceMessage"></div>

                <button type="button" class="btn btn-warning" id="saveDirectInvoiceBtn" onclick="saveDirectInvoice()" style="width: 100%;">‚ö° Guardar Solicitud de Timbrado</button>
            </form>
        </div>
    </div>


    <!-- Firebase y Scripts (Versi√≥n 8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script>
        // =========================================================
        // üö® 1. CONFIGURACI√ìN (CON TUS VALORES ACTUALIZADOS) üö®
        // =========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyB_H-Eu5PVkaWKanA0q7_Fo5LSPgBYhbhQ", 
            authDomain: "hotfact-9902f.firebaseapp.com",
            projectId: "hotfact-9902f",
            storageBucket: "hotfact-9902f.firebasestorage.app",
            messagingSenderId: "33455575295",
            appId: "1:33455575295:web:77d406be9d4f6a6ec5fcca"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let userData = {}; 

        // ====================================
        // FUNCIONES DE UTILIDAD
        // ====================================
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(amount);
        }

        function copyToClipboard(text, elementId) {
            navigator.clipboard.writeText(text).then(() => {
                const element = document.getElementById(elementId);
                const originalText = element.textContent;
                element.textContent = '‚úÖ ¬°Copiado!';
                setTimeout(() => {
                    element.textContent = originalText;
                }, 1500);
            }).catch(err => {
                console.error('Error al copiar: ', err);
                // Usar el m√©todo antiguo como fallback en caso de error
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    const element = document.getElementById(elementId);
                    const originalText = element.textContent;
                    element.textContent = '‚úÖ ¬°Copiado!';
                    setTimeout(() => {
                        element.textContent = originalText;
                    }, 1500);
                } catch(e) {
                     // NO USAR alert() como es regla en este ambiente
                     console.error('Fall√≥ el copiar al portapapeles en el fallback');
                }
            });
        }
        
        async function handleLogout() {
            // Reemplazo de confirm() por console.log, ya que confirm() est√° prohibido. 
            // En un entorno real, usar√≠as un modal custom.
            console.log('Cerrando sesi√≥n. (Si estuviera activo, un modal custom lo confirmar√≠a)');
            try {
                await auth.signOut();
                window.location.href = 'login.html'; // Aseg√∫rate de tener un login.html
            } catch (error) {
                console.error("Error al cerrar sesi√≥n:", error);
            }
        }
        
        function generateSimpleFolio() {
            return Math.floor(10000000 + Math.random() * 90000000).toString();
        }

        function getStatusClass(status) {
            switch(status) {
                case 'pendiente': return 'status-pendiente';
                case 'facturado': return 'status-facturado';
                case 'error': return 'status-error';
                case 'pendiente_timbrado': return 'status-pendiente_timbrado';
                default: return '';
            }
        }

        // ===================================================================================
        // FUNCI√ìN LOGO UPLOAD
        // ===================================================================================
        async function uploadLogo() {
            const logoInput = document.getElementById('logoFile');
            const resultDiv = document.getElementById('logoResult');
            const btn = document.getElementById('uploadLogoBtn');
            const file = logoInput.files[0];

            if (!file) {
                resultDiv.innerHTML = '<div class="error">Selecciona un archivo de imagen (PNG o JPG).</div>';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Subiendo...';
            resultDiv.innerHTML = '';
            
            try {
                // Ruta: logos/USER_ID/logo.png
                const logoRef = storage.ref(`logos/${userData.uid}/logo.png`);
                
                const snapshot = await logoRef.put(file);
                
                // Obtener la URL p√∫blica
                const logoUrl = await snapshot.ref.getDownloadURL();

                // Actualizar el documento del usuario en Firestore
                await db.collection('users').doc(userData.uid).update({
                    logoUrl: logoUrl,
                    logoUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                resultDiv.innerHTML = '<div class="success">‚úÖ Logo subido y guardado con √©xito.</div>';
                userData.logoUrl = logoUrl;

            } catch (error) {
                console.error("Error al subir el logo:", error);
                resultDiv.innerHTML = `<div class="error">Error al subir el logo: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üíæ Guardar y Subir Logo';
            }
        }
        
        // ===================================================================================
        // FUNCI√ìN GENERAR FOLIO
        // ===================================================================================
        async function generateFolio() {
            const amountInput = document.getElementById('folioAmount');
            const descriptionInput = document.getElementById('folioDescription');
            const resultDiv = document.getElementById('folioResult');
            
            const monto = parseFloat(amountInput.value);
            const description = descriptionInput.value.trim() || 'Venta de Productos/Servicios';

            if (isNaN(monto) || monto <= 0) {
                resultDiv.innerHTML = '<div class="error">Ingresa un monto v√°lido.</div>';
                return;
            }

            const subtotal = monto / 1.16;
            const iva = monto - subtotal;
            const folioCode = generateSimpleFolio();

            const folioData = {
                // Usamos el folioCode como ID del documento
                businessId: userData.uid,
                emisor: {
                    rfc: userData.rfc,
                    nombre: userData.nombre,
                    cp: userData.cp,
                    regimenFiscal: userData.regimenFiscal
                },
                description: description,
                conceptos: [
                    {
                        cantidad: 1,
                        descripcion: description,
                        // Asumimos ClaveProdServ y ClaveUnidad deben ser agregados por el usuario/sistema
                        claveProdServ: '84111506', // Servicios de facturaci√≥n (ejemplo)
                        claveUnidad: 'ACT', // Actividad
                        precioUnitario: parseFloat(subtotal.toFixed(2)),
                        subtotal: parseFloat(subtotal.toFixed(2))
                    }
                ],
                totales: {
                    subtotal: parseFloat(subtotal.toFixed(2)),
                    iva: parseFloat(iva.toFixed(2)),
                    total: parseFloat(monto.toFixed(2))
                },
                status: 'pendiente', 
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('folios').doc(folioCode).set(folioData);
                
                // La URL de facturaci√≥n debe ser hotfact.html, ya que es el archivo local
                const genericLink = "hotfact.html"; 
                
                resultDiv.innerHTML = `
                    <div class="folio-box">
                        <p style="color: white; text-align: center;">Folio generado. P√≠dele a tu cliente que ingrese a **${genericLink}** y que use el c√≥digo:</p>
                        <div class="folio-code" id="folioCodeDisplay" onclick="copyToClipboard('${folioCode}', 'folioCodeDisplay')">${folioCode}</div>
                        <button class="btn-copy" onclick="copyToClipboard('${folioCode}', 'folioCodeDisplay')">üìã Copiar C√ìDIGO</button>
                    </div>
                `;

                amountInput.value = '';
                descriptionInput.value = '';
                
            } catch (error) {
                console.error("Error al generar folio:", error);
                resultDiv.innerHTML = `<div class="error">Error al guardar el folio: ${error.message}</div>`;
            }
        }
        
        // ===================================================================================
        // MODAL FACTURACI√ìN DIRECTA
        // ===================================================================================
        function openDirectInvoiceModal() {
            document.getElementById('directInvoiceModal').classList.add('active');
            document.getElementById('directInvoiceMessage').innerHTML = '';
        }

        function closeDirectInvoiceModal() {
            document.getElementById('directInvoiceModal').classList.remove('active');
        }

        async function saveDirectInvoice() {
            const messageDiv = document.getElementById('directInvoiceMessage');
            const btn = document.getElementById('saveDirectInvoiceBtn');
            btn.disabled = true;
            btn.textContent = 'Guardando...';
            messageDiv.innerHTML = '';
            
            const rfc = document.getElementById('directReceptorRFC').value.toUpperCase();
            const nombre = document.getElementById('directReceptorNombre').value.trim();
            const email = document.getElementById('directReceptorEmail').value.trim();
            const usoCFDI = document.getElementById('directUsoCFDI').value;
            const regimenFiscal = document.getElementById('directRegimenFiscal').value;
            const monto = parseFloat(document.getElementById('directAmount').value);
            const description = document.getElementById('directConcepto').value.trim();

            if (!rfc || !nombre || !email || !usoCFDI || !regimenFiscal || isNaN(monto) || monto <= 0 || !description) {
                messageDiv.innerHTML = '<div class="error">Por favor, completa todos los campos requeridos y aseg√∫rate de que el monto es v√°lido.</div>';
                btn.disabled = false;
                btn.textContent = '‚ö° Guardar Solicitud de Timbrado';
                return;
            }
            
            const subtotal = monto / 1.16;
            const iva = monto - subtotal;

            const invoiceData = {
                businessId: userData.uid,
                emisor: {
                    rfc: userData.rfc,
                    nombre: userData.nombre,
                    cp: userData.cp,
                    regimenFiscal: userData.regimenFiscal
                },
                receptor: {
                    rfc: rfc,
                    nombre: nombre,
                    email: email,
                    cp: userData.cp, // Usamos el CP del emisor por simplicidad
                    regimenFiscal: regimenFiscal
                },
                cfdi: {
                    formaPago: "03", 
                    metodoPago: "PUE", 
                    moneda: "MXN",
                    usoCFDI: usoCFDI
                },
                conceptos: [
                    {
                        cantidad: 1,
                        descripcion: description,
                        claveProdServ: '84111506', // Ejemplo
                        claveUnidad: 'ACT', // Actividad
                        precioUnitario: parseFloat(subtotal.toFixed(2)),
                        subtotal: parseFloat(subtotal.toFixed(2))
                    }
                ],
                totales: {
                    subtotal: parseFloat(subtotal.toFixed(2)),
                    iva: parseFloat(iva.toFixed(2)),
                    total: parseFloat(monto.toFixed(2))
                },
                // La Cloud Function de timbrado directo debe escuchar este estado
                status: 'pendiente_timbrado', 
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                // Usamos otra colecci√≥n para no mezclar con los folios de cliente
                await db.collection('directInvoiceRequests').add(invoiceData);

                messageDiv.innerHTML = '<div class="success">‚úÖ Solicitud de factura guardada. Pendiente de timbrado.</div>';
                
                // Cerrar modal despu√©s de √©xito
                setTimeout(() => {
                    closeDirectInvoiceModal();
                    // Limpiar formulario si es necesario
                    document.getElementById('directInvoiceForm').reset();
                }, 2000);

            } catch (error) {
                console.error('Error guardando factura:', error);
                messageDiv.innerHTML = `<div class="error">Error al guardar solicitud: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ö° Guardar Solicitud de Timbrado';
            }
        }


        // ===================================================================================
        // CARGA DE DATOS DEL DASHBOARD EN TIEMPO REAL (onSnapshot)
        // ===================================================================================

        function setupRealtimeDashboard() {
            // Consulta combinada para folios y solicitudes directas
            const foliosRef = db.collection('folios').where('businessId', '==', userData.uid);
            const directRef = db.collection('directInvoiceRequests').where('businessId', '==', userData.uid);

            // Listener para folios de clientes (Colecci√≥n 'folios')
            foliosRef.onSnapshot(snapshot => updateDashboard(snapshot, 'folio'));

            // Listener para solicitudes directas (Colecci√≥n 'directInvoiceRequests')
            directRef.onSnapshot(snapshot => updateDashboard(snapshot, 'direct'));
        }

        let allInvoices = {}; // Objeto para mantener un registro √∫nico de todas las facturas
        
        function updateDashboard(snapshot, type) {
            let totalFolios = 0;
            let totalAmount = 0;
            let invoicedFolios = 0;
            let pendingFolios = 0;
            
            // 1. Procesar nuevos datos y actualizar el registro √∫nico
            snapshot.docChanges().forEach(change => {
                const docData = change.doc.data();
                const docId = `${type}_${change.doc.id}`; // Prefijo para asegurar IDs √∫nicos
                
                if (change.type === "added" || change.type === "modified") {
                    allInvoices[docId] = { id: change.doc.id, type: type, ...docData };
                } else if (change.type === "removed") {
                    delete allInvoices[docId];
                }
            });
            
            const foliosTableBody = document.getElementById('foliosTableBody');
            foliosTableBody.innerHTML = '';
            
            // 2. Calcular estad√≠sticas y re-renderizar la tabla
            const sortedInvoices = Object.values(allInvoices).sort((a, b) => {
                 // Asegurar que exista el timestamp antes de comparar
                const aTime = a.createdAt && a.createdAt.seconds ? a.createdAt.seconds : 0;
                const bTime = b.createdAt && b.createdAt.seconds ? b.createdAt.seconds : 0;
                return bTime - aTime;
            });

            sortedInvoices.forEach(docData => {
                totalFolios++;
                const montoTotal = docData.totales.total;
                
                if (docData.status === 'pendiente') {
                    pendingFolios++;
                    totalAmount += montoTotal;
                } else if (docData.status === 'facturado') {
                    invoicedFolios++;
                } else if (docData.status === 'pendiente_timbrado') {
                    // Cuentan como pendientes a nivel de monto
                    pendingFolios++;
                    totalAmount += montoTotal;
                }

                // Renderizar Fila
                const row = foliosTableBody.insertRow();
                const folioId = docData.type === 'folio' ? docData.id : `DIRECT-${docData.id.substring(0, 4)}...`;
                const description = docData.description || (docData.conceptos && docData.conceptos.length > 0 ? docData.conceptos[0].descripcion : 'Sin descripci√≥n');
                
                row.innerHTML = `
                    <td>${folioId}</td>
                    <td>${formatCurrency(montoTotal)}</td>
                    <td>${description}</td>
                    <td class="${getStatusClass(docData.status)}">${docData.status.toUpperCase().replace('_', ' ')}</td>
                    <td>
                        <button class="btn" style="background-color: #34495e; padding: 5px 10px; font-size: 12px;" onclick="descargarCFDI('${docData.uuid}', 'xml')">Descargar</button>
                    </td>
                `;
            });

            // 3. Actualizar la UI
            document.getElementById('totalFolios').textContent = totalFolios;
            document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
            document.getElementById('invoicedFolios').textContent = invoicedFolios;
            document.getElementById('pendingFolios').textContent = pendingFolios;

            if (totalFolios === 0) {
                 foliosTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay folios o solicitudes registrados.</td></tr>';
            }
        }
        
        // Funci√≥n placeholder de descarga (Debe ser implementada)
        function descargarCFDI(uuid, type) {
             if (uuid) {
                 // Aqu√≠ deber√≠as llamar a tu Cloud Function para obtener el XML/PDF en base64
                 // Ya que no lo guardamos en Firestore por defecto para ahorrar espacio
                 console.log(`Descargar CFDI con UUID ${uuid} y tipo ${type}`);
                 // Usar un modal custom para mostrar el mensaje
                 alert('La factura est√° timbrada. Se necesita un endpoint de Cloud Function para descargar el archivo.'); 
             } else {
                 alert('A√∫n no hay archivos de factura para descargar (UUID no disponible).');
             }
        }

        // ===================================================================================
        // AUTENTICACI√ìN Y CARGA INICIAL
        // ===================================================================================
        auth.onAuthStateChanged(user => {
            if (user) {
                // El usuario est√° logueado, cargar sus datos
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        // CRUCIAL: Cargar datos fiscales de la empresa desde 'users'
                        userData = { uid: user.uid, ...doc.data() };
                        document.getElementById('userName').textContent = userData.nombre || 'Administrador';
                        document.getElementById('userRFC').textContent = `RFC: ${userData.rfc || 'N/A'}`;
                        
                        setupRealtimeDashboard(); 
                    } else {
                        console.error("No se encontraron datos de la empresa. Aseg√∫rate de usar admin.html para registrar la informaci√≥n fiscal.");
                        handleLogout(); 
                    }
                }).catch(err => {
                    console.error("Error al obtener datos del usuario:", err);
                    handleLogout(); 
                });
            } else {
                // No logueado, redirigir
                window.location.href = 'login.html'; 
            }
        });

        // Inicializar listeners del modal
        window.addEventListener('DOMContentLoaded', () => {
            const directInvoiceForm = document.getElementById('directInvoiceForm');
            if (directInvoiceForm) {
                directInvoiceForm.addEventListener('submit', (e) => e.preventDefault());
            }
        });
    </script>
</body>
</html>